<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cerdas Berhitung</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Nunito', sans-serif; }
        h1, h2, h3 { font-family: 'Fredoka', sans-serif; }
        
        /* Animasi Transisi */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Kelas untuk tombol terkunci */
        .btn-locked {
            background-color: #e2e8f0 !important; /* slate-200 */
            color: #94a3b8 !important; /* slate-400 */
            border-color: #cbd5e1 !important; /* slate-300 */
            cursor: not-allowed;
            pointer-events: none;
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* Modal Overlay */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        /* Loader Animation */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- BAGIAN 1: VERIFIKASI / INTRO (Default View) -->
    <div id="auth-section" class="w-full max-w-md bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100 slide-up relative z-10">
        <div class="bg-indigo-600 p-8 text-center relative overflow-hidden">
            <!-- Decorative Circles -->
            <div class="absolute top-0 left-0 w-24 h-24 bg-white opacity-10 rounded-full -translate-x-10 -translate-y-10"></div>
            <div class="absolute bottom-0 right-0 w-16 h-16 bg-white opacity-10 rounded-full translate-x-5 translate-y-5"></div>
            
            <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                <i class="fas fa-graduation-cap text-4xl text-indigo-600"></i>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2">Cerdas Berhitung</h1>
            <p class="text-indigo-100 text-sm">Aplikasi untuk Melatih Keterampilan Berhitung</p>
        </div>

        <div class="p-8">
            <!-- Narasi / Syarat -->
            <div class="mb-6 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded text-sm text-yellow-800" id="syarat-box">
                <h3 class="font-bold mb-1"><i class="fas fa-info-circle mr-1"></i> Petunjuk</h3>
                <p>Silakan <strong>Login Aplikasi</strong> terlebih dahulu untuk membuka menu Cek Data dan Input Data.</p>
            </div>

            <!-- Pilihan Menu Awal -->
            <div id="initial-buttons" class="space-y-3">
                
                <!-- MENU 1: LOGIN (Akan disembunyikan jika sukses) -->
                <button id="btn-main-login" onclick="showAppLoginForm()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2">
                    <i class="fas fa-key"></i> Login Aplikasi
                </button>

                <!-- MENU 2: CEK DATA (Awalnya Terkunci) -->
                <button id="btn-cek-data" onclick="showCheckMenu()" class="btn-locked w-full py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200 transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2">
                    <i class="fas fa-search"></i> Cek Data<i class="fas fa-lock text-xs ml-1 opacity-50" id="lock-icon-1"></i>
                </button>

                <!-- MENU 3: INPUT DATA (Awalnya Terkunci) - DIGANTI JADI BUTTON -->
                <button id="btn-input-data" onclick="showInputMenu()" class="btn-locked block w-full py-3 bg-white border-2 border-indigo-100 text-indigo-600 hover:bg-indigo-50 rounded-xl font-bold text-center transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-user-plus"></i> Input Data<i class="fas fa-lock text-xs ml-1 opacity-50" id="lock-icon-2"></i>
                </button>

            </div>

            <!-- FORM LOGIN APLIKASI (Hidden Initially) -->
            <div id="app-login-form" class="hidden space-y-4 fade-in">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Login Akses</h3>
                    <p class="text-xs text-gray-500">Masukkan Kode Akses Aplikasi</p>
                </div>
                
                <div class="relative">
                    <i class="fas fa-shield-alt absolute left-4 top-3.5 text-gray-400"></i>
                    <input type="password" id="app-password-input" placeholder="Masukkan kode akses disini" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all">
                </div>

                <button onclick="verifyAppLogin()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all flex items-center justify-center gap-2">
                    <span>Masuk</span>
                    <i class="fas fa-arrow-right"></i>
                </button>

                <div class="flex justify-between items-center text-sm px-1">
                    <button onclick="hideAppLoginForm()" class="text-gray-400 hover:text-gray-600 underline">Batal</button>
                    <button onclick="showContactModal()" class="text-blue-500 hover:text-blue-700 font-semibold flex items-center gap-1">
                        <i class="fas fa-question-circle"></i> Butuh Bantuan?
                    </button>
                </div>
            </div>

            <!-- FORM CEK DATA SISWA (Hidden Initially) -->
            <div id="check-form" class="hidden space-y-4 fade-in">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Verifikasi Data</h3>
                    <p class="text-xs text-gray-500">Masukkan Nama Lengkap atau Asal Sekolah</p>
                </div>
                
                <div class="relative">
                    <i class="fas fa-user absolute left-4 top-3.5 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="Ketik Nama / Nama Sekolah..." class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all">
                </div>

                <button onclick="verifyUser()" id="btn-verify" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-bold shadow-lg shadow-green-200 transition-all flex items-center justify-center gap-2">
                    <span>Verifikasi dan Masuk</span>
                    <i class="fas fa-arrow-right"></i>
                </button>

                <!-- Tombol Lihat Daftar Siswa -->
                <div class="text-center mt-2">
                    <button onclick="showDataModal()" class="text-sm text-indigo-500 hover:text-indigo-700 font-semibold underline flex items-center justify-center gap-1 mx-auto transition-colors">
                        <i class="fas fa-list-ul"></i> Lihat Daftar Siswa
                    </button>
                </div>

                <button onclick="hideCheckMenu()" class="w-full text-sm text-gray-400 hover:text-gray-600 underline">Kembali</button>
            </div>

            <!-- FORM INPUT DATA BARU (Hidden Initially) -->
            <div id="input-form" class="hidden space-y-4 fade-in">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Input Data Siswa</h3>
                    <p class="text-xs text-gray-500">Silakan lengkapi data di bawah ini</p>
                </div>

                <form id="studentForm" name="submit-to-google-sheet">
                    <!-- Input Nama -->
                    <div class="mb-4 relative">
                        <label for="Nama" class="block text-sm font-medium text-gray-700 mb-1 text-left">Nama Lengkap</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-user text-gray-400"></i>
                            </div>
                            <input type="text" id="Nama" name="Nama" required class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors bg-gray-50 focus:bg-white" placeholder="Contoh: Budi Santoso">
                        </div>
                    </div>

                    <!-- Input Sekolah -->
                    <div class="mb-6 relative">
                        <label for="Sekolah" class="block text-sm font-medium text-gray-700 mb-1 text-left">Asal Sekolah</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-school text-gray-400"></i>
                            </div>
                            <input type="text" id="Sekolah" name="Sekolah" required class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors bg-gray-50 focus:bg-white" placeholder="Contoh: SMA Negeri 1 Jakarta">
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="btnSubmit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all shadow-lg flex justify-center items-center gap-2 group">
                        <span>Kirim Data</span>
                        <i class="fas fa-paper-plane group-hover:translate-x-1 transition-transform"></i>
                    </button>

                    <!-- Loading Spinner (Hidden by default) -->
                    <button type="button" id="btnLoading" disabled class="hidden w-full bg-indigo-400 text-white font-semibold py-3 px-4 rounded-lg cursor-not-allowed flex justify-center items-center gap-2">
                        <div class="loader"></div>
                        <span>Mengirim...</span>
                    </button>
                </form>

                <!-- Success Message -->
                <div id="successMessage" class="hidden mt-4 bg-green-50 border border-green-200 rounded-lg p-3 animate-fade-in-up">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 text-xl mr-2"></i>
                        <div>
                            <h3 class="text-sm font-medium text-green-800">Berhasil!</h3>
                            <p class="text-xs text-green-700">Data berhasil disimpan.</p>
                        </div>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="errorMessage" class="hidden mt-4 bg-red-50 border border-red-200 rounded-lg p-3 animate-fade-in-up">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle text-red-500 text-xl mr-2"></i>
                        <div>
                            <h3 class="text-sm font-medium text-red-800">Gagal!</h3>
                            <p class="text-xs text-red-700">Terjadi kesalahan jaringan.</p>
                        </div>
                    </div>
                </div>

                <button onclick="hideInputMenu()" class="w-full text-sm text-gray-400 hover:text-gray-600 underline mt-2">Kembali</button>
            </div>
            
            <!-- Alert Feedback (General) -->
            <div id="feedback-msg" class="hidden text-center text-sm p-2 rounded-lg mt-4"></div>

        </div>
        
        <div class="bg-gray-50 p-4 text-center border-t border-gray-100 relative z-10">
            <p class="text-xs text-gray-400">@ Wartam</p>
        </div>
    </div>

    <!-- BAGIAN 2: DASHBOARD MENU UTAMA (Hidden Default) -->
    <div id="dashboard-section" class="hidden w-full max-w-4xl fade-in relative z-10">
        
        <!-- Header Dashboard -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 flex flex-col md:flex-row items-center justify-between border border-white/50 backdrop-blur-sm bg-opacity-90">
            <div class="flex items-center gap-4 mb-4 md:mb-0">
                <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 text-xl font-bold">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div>
                    <!-- ID DITAMBAHKAN DISINI UNTUK GANTI NAMA -->
                    <h2 id="greeting-text" class="text-xl font-bold text-gray-800">Halo, Pelajar!</h2>
                    <p class="text-sm text-gray-500">Silakan pilih menu yang ada. Jika ada 2 link pilih satu link yang tersedia</p>
                </div>
            </div>
            <button onclick="logout()" class="px-4 py-2 bg-red-50 text-red-500 hover:bg-red-100 rounded-lg text-sm font-bold transition-colors">
                <i class="fas fa-sign-out-alt mr-1"></i> Keluar
            </button>
        </div>

        <!-- Grid Menu -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="menu-grid">
            <!-- Menu items will be injected here via JS -->
        </div>

    </div>

    <!-- MODAL POPUP CONTACT -->
    <div id="contact-modal" class="fixed inset-0 modal-overlay hidden flex items-center justify-center z-50 fade-in">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 text-center relative transform transition-all scale-100">
            
            <!-- Icon -->
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl shadow-sm">
                <i class="fas fa-headset"></i>
            </div>
            
            <!-- Text -->
            <h3 class="text-xl font-bold text-gray-800 mb-2">Hubungi Admin</h3>
            <p class="text-gray-600 mb-6 text-sm">
                Silakan pilih keperluan Anda di bawah ini:
            </p>
            
            <!-- PILIHAN 1: PAKAI APLIKASI (MERAH - Membuka Info Kode) -->
            <button onclick="showCodeInfo()" class="block w-full py-3 bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 text-white rounded-xl font-bold mb-3 transition-all transform hover:scale-[1.02] shadow-lg shadow-red-200 flex items-center justify-center gap-2 group">
                <i class="fas fa-unlock-alt text-2xl group-hover:rotate-12 transition-transform"></i> 
                <span>Pakai Aplikasi</span>
            </button>

            <!-- PILIHAN 2: MEMBUAT APLIKASI (HIJAU - WHATSAPP) -->
            <a href="https://wa.me/628156095823?text=Halo,%20saya%20tertarik%20ingin%20membuat%20aplikasi%20seperti%20Cerdas%20Berhitung.%20Mohon%20infonya.%0A%0ANama:%20...%0A%0AInstansi:%20..." target="_blank" class="block w-full py-3 bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white rounded-xl font-bold mb-3 transition-all transform hover:scale-[1.02] shadow-lg shadow-green-200 flex items-center justify-center gap-2 group">
                <!-- Icon diubah menjadi WhatsApp -->
                <i class="fab fa-whatsapp text-2xl group-hover:rotate-12 transition-transform"></i> 
                <span>Buat Aplikasi</span>
            </a>
            
            <!-- Close Button -->
            <button onclick="closeContactModal()" class="w-full py-2 text-gray-400 hover:text-gray-600 text-sm font-medium transition-colors">
                Tutup Jendela
            </button>
        </div>
    </div>

    <!-- MODAL POPUP INFO KODE -->
    <div id="code-info-modal" class="fixed inset-0 modal-overlay hidden flex items-center justify-center z-[60] fade-in">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 text-center relative transform transition-all scale-100">
            <!-- Icon -->
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600 text-2xl shadow-sm">
                <i class="fas fa-key"></i>
            </div>
            
            <!-- Text -->
            <h3 class="text-xl font-bold text-gray-800 mb-2">Kode Akses Aplikasi</h3>
            <p class="text-gray-600 mb-4 text-sm">
                Gunakan kode di bawah ini untuk masuk:
            </p>
            
            <!-- Kode Display -->
            <div class="bg-gray-100 p-4 rounded-xl border border-gray-200 mb-6">
                <span class="text-2xl font-mono font-bold text-gray-800 tracking-wider">hitung12345</span>
            </div>
            
            <!-- Button -->
            <button onclick="closeCodeInfo()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold transition-colors shadow-lg shadow-indigo-200">
                Tutup & Login
            </button>
        </div>
    </div>

    <!-- MODAL POPUP DATA SISWA -->
    <div id="data-modal" class="fixed inset-0 modal-overlay hidden flex items-center justify-center z-50 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 flex flex-col max-h-[85vh] relative transform transition-all scale-100">
            <!-- Header Modal -->
            <div class="p-5 bg-indigo-600 text-white rounded-t-2xl flex justify-between items-center shrink-0">
                 <div class="flex items-center gap-2">
                     <i class="fas fa-users text-lg"></i>
                     <h3 class="text-lg font-bold">Data Terdaftar</h3>
                 </div>
                 <button onclick="closeDataModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/20 hover:bg-white/30 transition-colors">
                     <i class="fas fa-times"></i>
                 </button>
            </div>
            
            <!-- Content Area (Scrollable) -->
            <div class="p-0 overflow-y-auto custom-scroll flex-1 relative bg-gray-50">
                 <!-- Loader -->
                 <div id="data-loader" class="flex flex-col items-center justify-center py-20">
                     <div class="loader border-indigo-200 border-t-indigo-600 w-10 h-10 mb-3"></div>
                     <span class="text-sm text-gray-500">Memuat data dari database...</span>
                 </div>
                 
                 <!-- Table Container -->
                 <div class="p-4">
                    <table id="data-table" class="w-full text-left border-collapse hidden bg-white rounded-lg shadow-sm overflow-hidden">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-3 border-b border-gray-200 font-bold text-gray-600 text-xs uppercase tracking-wider w-12 text-center">No</th>
                                <th class="p-3 border-b border-gray-200 font-bold text-gray-600 text-xs uppercase tracking-wider">Nama Lengkap</th>
                                <th class="p-3 border-b border-gray-200 font-bold text-gray-600 text-xs uppercase tracking-wider">Asal Sekolah</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="text-sm text-gray-700 divide-y divide-gray-100">
                            <!-- Rows generated by JS -->
                        </tbody>
                    </table>

                    <!-- Empty State -->
                    <div id="data-empty" class="hidden flex flex-col items-center justify-center py-10 text-center">
                        <i class="fas fa-inbox text-gray-300 text-4xl mb-2"></i>
                        <p class="text-gray-500 text-sm">Belum ada data siswa ditemukan.</p>
                    </div>
                 </div>
            </div>
            
            <!-- Footer Modal -->
            <div class="p-4 border-t border-gray-100 text-right bg-white rounded-b-2xl shrink-0">
                 <button onclick="closeDataModal()" class="px-5 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg text-sm font-bold transition-colors">
                     Tutup
                 </button>
            </div>
        </div>
    </div>

    <!-- MODAL POPUP GAMES (IFRAME) - DISEDERHANAKAN -->
    <div id="game-modal" class="fixed inset-0 modal-overlay hidden flex flex-col z-[100] fade-in">
        <!-- Header Game Modal -->
        <div class="bg-indigo-600 text-white p-3 flex justify-between items-center shadow-md shrink-0">
            <h3 id="game-title" class="font-bold text-lg truncate px-2">Materi Belajar</h3>
            <div class="flex items-center gap-2">
                <!-- TOMBOL TAB BARU -->
                <a id="game-fallback-btn" href="#" target="_blank" class="text-sm font-bold bg-yellow-400 hover:bg-yellow-500 text-indigo-900 px-4 py-2 rounded-lg transition-colors flex items-center gap-2 shadow-sm">
                    <i class="fas fa-external-link-alt"></i> Buka Layar Penuh
                </a>
                <button onclick="closeGameModal()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/20 hover:bg-white/30 text-white transition-colors ml-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <!-- Iframe Container -->
        <div class="flex-1 bg-gray-100 relative w-full h-full">
            <div id="game-loader" class="absolute inset-0 flex flex-col items-center justify-center bg-white z-10">
                <div class="loader border-indigo-200 border-t-indigo-600 w-12 h-12 mb-3"></div>
                <p class="text-gray-500 text-sm mb-4">Memuat aplikasi...</p>
                
                <!-- Pesan Bantuan jika loading macet -->
                <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-center max-w-xs">
                    <p class="text-xs text-yellow-800">
                        Jika layar tetap putih atau muncul error, klik tombol <strong>"Buka Layar Penuh"</strong> di pojok kanan atas.
                    </p>
                </div>
            </div>
            
            <iframe id="game-frame" class="w-full h-full border-0" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals" onload="hideGameLoader()"></iframe>
        </div>
    </div>

    <script>
        // --- KONFIGURASI DATA ---
        const SHEET_ID = '1nwPNJxXlqMQFUBhrCXnrlLIfeTlV7TViWyDEKlZm28c';
        const SHEET_NAME = 'nama'; 
        const APP_ACCESS_CODE = 'hitung12345'; 
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyO2JuU8h6JtNq1Tbcget2pqz8BtSbj-g7SOvB3v7OjhsasX551S_TCxL5gGis2tSHQaw/exec'; 
        
        const menuItems = [
            { 
                id: 2, 
                title: "Penjumlahan", 
                desc: "Mengasah keterampilan berhitung operasi penjumlahan", 
                icon: "fa-plus", 
                color: "bg-blue-500", 
                bg: "bg-blue-50", 
                text: "text-blue-600", 
                url: "https://script.google.com/macros/s/AKfycbwO1xRFTwbwteijgB01zjWMzzmZ7ZbMZLeyMhEgvSB6RC34r1AN9sOpCaqbAHSEzsHl/exec",
                altUrl: "https://script.google.com/a/~/macros/s/AKfycbwO1xRFTwbwteijgB01zjWMzzmZ7ZbMZLeyMhEgvSB6RC34r1AN9sOpCaqbAHSEzsHl/exec" // CONTOH ALT SAMA, GANTI DENGAN YANG BEDA
            },
            { 
                id: 3, 
                title: "Pengurangan", 
                desc: "Mengasah keterampilan berhitung operasi pengurangan", 
                icon: "fa-minus", 
                color: "bg-orange-500", 
                bg: "bg-orange-50", 
                text: "text-orange-600", 
                url: "https://script.google.com/macros/s/AKfycbyrTSXJluCIDliCyr6mOMIBQaENndwzDt6zuk7WBhutkQ0cxANdkH3-FO7I_d-gc2FPgg/exec",
                altUrl: "https://script.google.com/a/~/macros/s/AKfycbyrTSXJluCIDliCyr6mOMIBQaENndwzDt6zuk7WBhutkQ0cxANdkH3-FO7I_d-gc2FPgg/exec"
            },
            { 
                id: 4, 
                title: "Perkalian", 
                desc: "Mengasah keterampilan berhitung operasi perkalian", 
                icon: "fa-times", 
                color: "bg-purple-500", 
                bg: "bg-purple-50", 
                text: "text-purple-600", 
                url: "https://script.google.com/macros/s/AKfycbwXsvA3LIwJiUt4TinLtOp9BfkCS4omhmi24peg0wQz-1uzK67dsLMjSDawyaktJfpMKg/exec",
                altUrl: "https://script.google.com/a/~/macros/s/AKfycbwXsvA3LIwJiUt4TinLtOp9BfkCS4omhmi24peg0wQz-1uzK67dsLMjSDawyaktJfpMKg/exec"
            },
            { 
                id: 5, 
                title: "Pembagian", 
                desc: "Mengasah keterampilan berhitung operasi pembagian", 
                icon: "fa-divide", 
                color: "bg-pink-500", 
                bg: "bg-pink-50", 
                text: "text-pink-600", 
                url: "https://script.google.com/macros/s/AKfycbwGJ9yVIiGbykizvsrwCcispO-enIY1NeZOhqieqQPFkRgySy9LtyGCJlVYstUgooAN/exec",
                altUrl: "https://script.google.com/a/~/macros/s/AKfycbwGJ9yVIiGbykizvsrwCcispO-enIY1NeZOhqieqQPFkRgySy9LtyGCJlVYstUgooAN/exec"
            },
            { 
                id: 6, 
                title: "Kompetisi", 
                desc: "Mengasah keterampilan berhitung secara kolaboratif", 
                icon: "fa-trophy", 
                color: "bg-yellow-500", 
                bg: "bg-yellow-50", 
                text: "text-yellow-600", 
                url: "https://wartam47.github.io/balapan_mobil",
                altUrl: "" // Kosongkan untuk menampilkan satu tombol saja
            }
        ];

        // --- DOM ELEMENTS ---
        const authSection = document.getElementById('auth-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const initialButtons = document.getElementById('initial-buttons');
        const appLoginForm = document.getElementById('app-login-form');
        const checkForm = document.getElementById('check-form');
        const inputForm = document.getElementById('input-form');
        const searchInput = document.getElementById('search-input');
        const feedbackMsg = document.getElementById('feedback-msg');
        const btnVerify = document.getElementById('btn-verify');
        const greetingText = document.getElementById('greeting-text');
        const syaratBox = document.getElementById('syarat-box');
        
        // Buttons Utama
        const btnMainLogin = document.getElementById('btn-main-login');
        const btnCekData = document.getElementById('btn-cek-data');
        const btnInputData = document.getElementById('btn-input-data');
        const lockIcon1 = document.getElementById('lock-icon-1');
        const lockIcon2 = document.getElementById('lock-icon-2');

        // Modal Contact & Code Info
        const contactModal = document.getElementById('contact-modal');
        const codeInfoModal = document.getElementById('code-info-modal');
        
        // Modal Data Siswa
        const dataModal = document.getElementById('data-modal');
        const dataLoader = document.getElementById('data-loader');
        const dataTable = document.getElementById('data-table');
        const dataTableBody = document.getElementById('data-table-body');
        const dataEmpty = document.getElementById('data-empty');

        // Game Modal (Iframe)
        const gameModal = document.getElementById('game-modal');
        const gameFrame = document.getElementById('game-frame');
        const gameTitle = document.getElementById('game-title');
        const gameLoader = document.getElementById('game-loader');
        const gameFallbackBtn = document.getElementById('game-fallback-btn');

        // Form Submission Elements
        const formSubmit = document.forms['submit-to-google-sheet'];
        const btnSubmit = document.getElementById('btnSubmit');
        const btnLoading = document.getElementById('btnLoading');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');

        // --- LOGIKA GAME MODAL (IFRAME) ---
        function openGame(url, title) {
            gameModal.classList.remove('hidden');
            gameLoader.classList.remove('hidden'); // Show loader
            gameTitle.innerText = title;
            gameFrame.src = url;
            gameFallbackBtn.href = url;
        }

        function closeGameModal() {
            gameModal.classList.add('hidden');
            gameFrame.src = ""; // Stop execution
        }

        function hideGameLoader() {
            setTimeout(() => {
                gameLoader.classList.add('hidden');
            }, 1500); 
        }

        // --- LOGIKA MODAL INFO KODE ---
        function showCodeInfo() {
            closeContactModal(); // Tutup modal pilihan
            codeInfoModal.classList.remove('hidden'); // Buka modal info kode
        }

        function closeCodeInfo() {
            codeInfoModal.classList.add('hidden');
            setTimeout(() => {
                document.getElementById('app-password-input').focus();
            }, 100);
        }

        // --- LOGIKA MODAL DATA SISWA ---
        function showDataModal() {
            dataModal.classList.remove('hidden');
            fetchDataList();
        }

        function closeDataModal() {
            dataModal.classList.add('hidden');
        }

        async function fetchDataList() {
            dataLoader.classList.remove('hidden');
            dataTable.classList.add('hidden');
            dataEmpty.classList.add('hidden');
            dataTableBody.innerHTML = '';

            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
                const response = await fetch(url);
                const csvText = await response.text();
                
                const rows = csvText.split('\n');
                let count = 0;

                rows.forEach((row, index) => {
                    let cleanedRow = row.replace(/"/g, ''); 
                    if (!cleanedRow.trim()) return;

                    let cols = cleanedRow.split(',');
                    if (cols.length < 2) return;
                    
                    let nama = cols[0].trim();
                    let sekolah = cols[1].trim();

                    if (index === 0 && (nama.toLowerCase().includes('nama'))) return;
                    
                    count++;
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-indigo-50 transition-colors";
                    tr.innerHTML = `
                        <td class="p-3 text-center text-gray-400 font-mono text-xs">${count}</td>
                        <td class="p-3 font-medium text-gray-800 capitalize">${nama}</td>
                        <td class="p-3 text-gray-600 capitalize text-xs">${sekolah}</td>
                    `;
                    dataTableBody.appendChild(tr);
                });

                dataLoader.classList.add('hidden');
                
                if (count > 0) {
                    dataTable.classList.remove('hidden');
                } else {
                    dataEmpty.classList.remove('hidden');
                }

            } catch (error) {
                console.error(error);
                dataLoader.classList.add('hidden');
                dataEmpty.innerHTML = '<p class="text-red-500">Gagal memuat data. Periksa koneksi internet.</p>';
                dataEmpty.classList.remove('hidden');
            }
        }

        // --- LOGIKA FORM INPUT DATA BARU ---

        function showInputMenu() {
            initialButtons.classList.add('hidden');
            inputForm.classList.remove('hidden');
            hideFeedback();
        }

        function hideInputMenu() {
            inputForm.classList.add('hidden');
            initialButtons.classList.remove('hidden');
            initialButtons.classList.add('fade-in');
            hideFeedback();
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
        }

        if(formSubmit) {
            formSubmit.addEventListener('submit', e => {
                e.preventDefault();
                btnSubmit.classList.add('hidden');
                btnLoading.classList.remove('hidden');
                btnLoading.classList.add('flex');
                successMessage.classList.add('hidden');
                errorMessage.classList.add('hidden');

                fetch(scriptURL, { method: 'POST', body: new FormData(formSubmit)})
                    .then(response => {
                        btnLoading.classList.add('hidden');
                        btnLoading.classList.remove('flex');
                        btnSubmit.classList.remove('hidden');
                        successMessage.classList.remove('hidden');
                        formSubmit.reset();
                        setTimeout(() => { successMessage.classList.add('hidden'); }, 5000);
                    })
                    .catch(error => {
                        btnLoading.classList.add('hidden');
                        btnLoading.classList.remove('flex');
                        btnSubmit.classList.remove('hidden');
                        errorMessage.classList.remove('hidden');
                    });
            });
        }


        // --- LOGIKA MODAL CONTACT ---
        function showContactModal() {
            contactModal.classList.remove('hidden');
        }

        function closeContactModal() {
            contactModal.classList.add('hidden');
        }

        window.addEventListener('click', function(e) {
            if (e.target === contactModal) closeContactModal();
            if (e.target === dataModal) closeDataModal();
            if (e.target === codeInfoModal) closeCodeInfo();
        });

        // --- LOGIKA LOGIN APLIKASI (UTAMA) ---

        function showAppLoginForm() {
            initialButtons.classList.add('hidden');
            appLoginForm.classList.remove('hidden');
            document.getElementById('app-password-input').focus();
            hideFeedback();
        }

        function hideAppLoginForm() {
            appLoginForm.classList.add('hidden');
            initialButtons.classList.remove('hidden');
            hideFeedback();
        }

        function verifyAppLogin() {
            const inputCode = document.getElementById('app-password-input').value;
            
            if (inputCode === APP_ACCESS_CODE) {
                localStorage.setItem('appUnlocked', 'true');
                unlockAppFeatures();
                hideAppLoginForm();
                showFeedback("Akses Diterima!", "green");
                setTimeout(hideFeedback, 2000);
            } else {
                showFeedback("Kode Salah! Coba lagi.", "red");
            }
        }

        function unlockAppFeatures() {
            btnCekData.classList.remove('btn-locked');
            btnInputData.classList.remove('btn-locked');
            btnMainLogin.classList.add('hidden');
            if(lockIcon1) lockIcon1.style.display = 'none';
            if(lockIcon2) lockIcon2.style.display = 'none';

            syaratBox.innerHTML = `
                <h3 class="font-bold mb-1"><i class="fas fa-check-circle mr-1"></i> Petunjuk</h3>
                <p>Silakan cek data Anda di menu <strong>Cek Data</strong>. Jika belum ada, silakan akses menu <strong>Input Data</strong>.</p>
            `;
            syaratBox.classList.replace('border-yellow-400', 'border-green-400');
            syaratBox.classList.replace('bg-yellow-50', 'bg-green-50');
            syaratBox.classList.replace('text-yellow-800', 'text-green-800');
        }

        // --- LOGIKA CEK DATA SISWA ---

        function showCheckMenu() {
            initialButtons.classList.add('hidden');
            checkForm.classList.remove('hidden');
            checkForm.classList.add('fade-in');
            searchInput.focus();
            hideFeedback();
        }

        function hideCheckMenu() {
            checkForm.classList.add('hidden');
            initialButtons.classList.remove('hidden');
            initialButtons.classList.add('fade-in');
            hideFeedback();
        }

        function renderDashboard() {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            menuItems.forEach(item => {
                const card = document.createElement('div');
                card.className = `block ${item.bg} border border-transparent hover:border-${item.text.split('-')[1]}-200 rounded-2xl p-6 transition-all hover:-translate-y-1 hover:shadow-lg group flex flex-col h-full`;

                // Logika Tombol
                let actionButtons = '';
                // Mengambil warna dasar (blue, orange, dll)
                const baseColor = item.text.split('-')[1]; 

                if (item.altUrl && item.altUrl !== "") {
                    // Jika ada Alt URL (Penjumlahan s/d Pembagian) -> 2 Tombol
                    actionButtons = `
                        <div class="mt-4 grid grid-cols-2 gap-2">
                            <!-- Link 1: Background diubah dari putih menjadi warna-100 -->
                            <button onclick="openGame('${item.url}', '${item.title} - Server 1')" class="py-2 px-3 bg-${baseColor}-100 text-${baseColor}-700 border border-${baseColor}-200 rounded-lg text-sm font-bold hover:bg-${baseColor}-200 transition-colors shadow-sm">
                                Link 1
                            </button>
                            <!-- Link 2: Tetap warna solid -->
                            <button onclick="openGame('${item.altUrl}', '${item.title} - Server 2')" class="py-2 px-3 bg-${baseColor}-600 text-white rounded-lg text-sm font-bold hover:bg-${baseColor}-700 transition-colors shadow-sm">
                                Link 2
                            </button>
                        </div>
                    `;
                } else {
                    // Jika tidak ada Alt URL (Kompetisi) -> 1 Tombol
                    actionButtons = `
                        <div class="mt-4">
                            <button onclick="openGame('${item.url}', '${item.title}')" class="w-full py-2 px-3 bg-${baseColor}-600 text-white rounded-lg text-sm font-bold hover:bg-${baseColor}-700 transition-colors shadow-sm flex items-center justify-center gap-2">
                                <i class="fas fa-play"></i> Mulai
                            </button>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 ${item.color} rounded-xl flex items-center justify-center text-white text-xl shadow-md group-hover:scale-110 transition-transform">
                                <i class="fas ${item.icon}"></i>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-1">${item.title}</h3>
                        <p class="text-sm text-gray-500">${item.desc}</p>
                    </div>
                    ${actionButtons}
                `;
                grid.appendChild(card);
            });
        }

        function switchToDashboard() {
            authSection.classList.add('hidden');
            dashboardSection.classList.remove('hidden');
            const savedName = localStorage.getItem('mathAppName') || "Pelajar";
            const formattedName = savedName.replace(/\b\w/g, l => l.toUpperCase());
            greetingText.innerText = `Halo, ${formattedName}!`;
            renderDashboard();
            localStorage.setItem('mathAppAuth', 'true');
        }

        function logout() {
            localStorage.removeItem('mathAppAuth');
            localStorage.removeItem('mathAppName');
            localStorage.removeItem('appUnlocked'); 
            location.reload();
        }

        // --- VERIFIKASI GOOGLE SHEET ---

        async function verifyUser() {
            const query = searchInput.value.trim().toLowerCase();
            if (!query) {
                showFeedback("Harap masukkan Nama atau Sekolah!", "red");
                return;
            }

            const originalBtnContent = btnVerify.innerHTML;
            btnVerify.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memeriksa...';
            btnVerify.disabled = true;

            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error("Gagal mengambil data");
                const csvText = await response.text();
                const foundName = parseAndSearchCSV(csvText, query);

                if (foundName) {
                    localStorage.setItem('mathAppName', foundName);
                    showFeedback(`Data ditemukan! Selamat datang, ${foundName}`, "green");
                    setTimeout(switchToDashboard, 1500);
                } else {
                    showFeedback(`Data "${searchInput.value}" tidak ditemukan.`, "red");
                    btnVerify.innerHTML = originalBtnContent;
                    btnVerify.disabled = false;
                }
            } catch (error) {
                console.error(error);
                showFeedback("Terjadi kesalahan koneksi atau Sheet belum dipublikasikan.", "red");
                btnVerify.innerHTML = originalBtnContent;
                btnVerify.disabled = false;
            }
        }

        function parseAndSearchCSV(csvText, query) {
            const rows = csvText.split('\n');
            for (let i = 0; i < rows.length; i++) {
                let rowData = rows[i].replace(/"/g, '').split(',');
                if (rowData.length >= 2) {
                    const realName = rowData[0] ? rowData[0].trim() : "";
                    const realSchool = rowData[1] ? rowData[1].trim() : "";
                    const colA = realName.toLowerCase(); 
                    const colB = realSchool.toLowerCase(); 
                    
                    const isNameExact = colA === query; 
                    const isSchoolExact = colB === query; 
                    const isSchoolPartial = query.length >= 3 && colB.includes(query);

                    if (isNameExact || isSchoolExact || isSchoolPartial) {
                        return realName;
                    }
                }
            }
            return null;
        }

        function showFeedback(msg, colorType) {
            feedbackMsg.innerText = msg;
            feedbackMsg.classList.remove('hidden', 'text-red-600', 'bg-red-50', 'text-green-600', 'bg-green-50');
            if (colorType === "red") {
                feedbackMsg.classList.add('text-red-600', 'bg-red-50');
            } else {
                feedbackMsg.classList.add('text-green-600', 'bg-green-50');
            }
        }
        
        function hideFeedback() {
            feedbackMsg.classList.add('hidden');
        }

        // --- INIT ---
        document.addEventListener("DOMContentLoaded", () => {
            if (localStorage.getItem('mathAppAuth') === 'true') {
                switchToDashboard();
            } 
            else if (localStorage.getItem('appUnlocked') === 'true') {
                unlockAppFeatures();
            }

            searchInput.addEventListener("keypress", function(event) { if (event.key === "Enter") { event.preventDefault(); verifyUser(); }});
            document.getElementById('app-password-input').addEventListener("keypress", function(event) { if (event.key === "Enter") { event.preventDefault(); verifyAppLogin(); }});
        });

    </script>
</body>
</html>
